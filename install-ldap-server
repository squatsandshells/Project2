#Provides help via -h or --help command line options
if [ "$1" == "-h" ]; then echo "To use this script type ./install-ldap-server ,this script will install LDAP and add authentication." ; exit 0 ; fi
if [ "$1" == "-help" ]; then echo "To use this script type ./install-ldap-server ,this script will install LDAP and add authentication." ; exit 0 ; fi

#Installing LDAP
echo "Installing OpenLDAP" | tee -a LDAP-Install.log; yum install -y openldap-clients openldap-servers | tee -a LDAP-Install.log; echo "Installation Finished" | tee -a LDAP-Install.log

#Configuring ldif file
cp /etc/openldap/slapd.d/cn=config/olcDatabase={2}hdb.ldif /etc/openldap/slapd.d/cn=config/olcDatabase={2}hdb.ldif.BAK

sed -i 's/olcSuffix: dc=my-domain,dc=com/olcSuffix: dc=cit470,dc=nku,dc=edu/g' /etc/openldap/slapd.d/cn=config/olcDatabase={2}hdb.ldif | tee -a LDAP-Install.log

sed -i 's/olcRootDN: cn=Manager,dc=my-domain,dc=com/olcRootDN: cn=Manager,dc=cit470,dc=nku,dc=edu/g' /etc/openldap/slapd.d/cn=config/olcDatabase={2}hdb.ldif | tee -a LDAP-Install.log

echo 'olcRootPW: {SSHA}yYpIzTPA6IlTxcVbz9ubY0bTySY01qJT' >> /etc/openldap/slapd.d/cn=config/olcDatabase={2}hdb.ldif

#Starting slapd service
chown -R ldap:ldap /var/lib/ldap; systemctl start slapd.service | tee -a LDAP-Install.log; systemctl enable slapd | tee -a LDAP-Install.log

#Configuring LDAP Firewall
firewall-cmd --zone=public --add-service=ldap --permanent | tee -a LDAP-Install.log; firewall-cmd --zone=public --add-service=ldaps --permanent | tee -a LDAP-Install.log; firewall-cmd --reload

#Installing NSS and Migration Tools
yum install -y nss_ldap migrationtools | tee -a LDAP-Install.log

#Making a backup and adding basedn
cp /usr/share/migrationtools/migrate_common.ph /usr/share/migrationtools/migrate_common.ph.BAK | tee -a LDAP-Install.log

sed -i 's/$DEFAULT_MAIL_DOMAIN = "padl.com";/$DEFAULT_MAIL_DOMAIN = "nku.edu"/g' /usr/share/migrationtools/migration_common.ph | tee -a LDAP-Install.log

sed -i 's/$DEFAULT_BASE = "dc=pad1,dc=com";/$DEFAULT_BASE = "dc=cit470,dc=nku,dc=edu"/g' /usr/share/migrationtools/migration_common.ph | tee -a LDAP-Install.log

#Creating base.ldif and adding classes and attributes
echo 'dn: dc=cit470,dc=nku,dc=edu\ndc: cit470\nobjectClass: top\nobjectClass: domain' >> /usr/share/migrationtools/base.ldif | tee -a LDAP-Install.log

echo 'ou=People,dc=cit470,dc=nku,dc=edu\nou: People\nobjectClass: top\nobjectClass: organizationalUnit' >> /usr/share/migrationtools/base.ldif | tee -a LDAP-Install.log

echo 'dn: ou=Group,dc=cit470,dc=nku,dc=edu\nou: Group\nobjectClass: top\nobjectClass: organizationalUnit' >> /usr/share/migrationtools/base.ldif | tee -a LDAP-Install.log

#Adding schemas to support object classes and attributes
ldapadd -Y EXTERNAL -H ldapi:// -f /etc/openldap/schema/core.ldif | tee -a LDAP-Install.log; ldapadd -Y EXTERNAL -H ldapi:// -f /etc/openldap/schema/cosine.ldif | tee -a LDAP-Install.log; ldapadd -Y EXTERNAL -H ldapi:// -f /etc/openldap/schema/nis.ldif | tee -a LDAP-Install.log; ldapadd -Y EXTERNAL -H ldapi:// -f /etc/openldap/schema/inetorgperson.ldif | tee -a LDAP-Install.log

#Fixing ownership of files
systemctl stop slapd.service | tee -a LDAP-Install.log; chown -R ldap:ldap /var/lib/ldap | tee -a LDAP-Install.log

#Migrating passwords and groups and restarting slapd
cd /usr/share/migrationtools/; ./migrate_passwd.pl /etc/passwd > passwd.ldif | tee -a LDAP-Install.log; slapadd -v -l passwd.ldif | tee -a LDAP-Install.log

./migrate_group.pl /etc/group > group.ldif | tee -a LDAP-Install.log; slapadd -v -l rgroup.ldif | tee -a LDAP-Install.log; chown -R ldap.ldap /var/lib/ldap | tee -a LDAP-Install.log; systemctl start slapd | tee -a LDAP-Install.log; cd ~

#Adding the diradm utility, also installs wget in case it was not already
yum install -y wget bz2 tar| tee -a LDAP-Install.log; wget http://www.hits.at/diradm/diradm-1.3.tar.gz | tee -a LDAP-Install.log; tar zxvf diradm-1.3.tar.gz | tee -a LDAP-Install.log; cp diradm-1.3/diradm.conf /etc/ | tee -a LDAP-Install.log

echo "Finished setup" | tee -a NFS-Install.log
